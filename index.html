<!DOCTYPE html>
<html>
<head>
  <title>Send Gmail Draft</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>
  <script src="firebase-init.js" defer></script>
  <!-- Removed duplicate Firebase and GSI script includes -->
  <style>
    body { font-family: Arial, sans-serif; padding: 2rem; background: #f4f4f4; }
    input, button { padding: 10px; margin: 5px; width: 100%; max-width: 400px; }
    #status { margin-top: 10px; font-weight: bold; }
    #draftListContainer { border: 1px solid #ccc; background: white; max-height: 200px; overflow-y: auto; margin-bottom: 10px; padding: 5px; }
    .draft-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; }
    .draft-item:hover { background-color: #f0f0f0; }
    .draft-item.selected-for-sending { background-color: #d4edda; font-weight: bold; } /* Light green for selected to send */
    .draft-item.previewing { background-color: #e2e3e5; } /* Light grey for previewing */
    #draftPreviewArea { border: 1px solid #ccc; background: white; min-height: 100px; padding: 10px; margin-bottom: 10px; white-space: pre-wrap; word-wrap: break-word; }
    #draftPreviewArea h4 { margin-top: 0; }
  </style>
</head>
<body>
  <h2>Send Gmail Draft</h2>
  <div id="gSignInDiv"></div>
  <div id="app" style="display:none">
    <label style="display: block; margin-bottom: 5px;">Drafts (Single-click to preview, Double-click to select for sending):</label>
    <div id="draftListContainer">
      <p>-- Loading drafts --</p>
    </div>
    <label style="display: block; margin-bottom: 5px;">Draft Preview:</label>
    <div id="draftPreviewArea">
      <p>-- Click a draft above to see its content --</p>
    </div>
    <input id="recipient" placeholder="Recipient Email">
    <button id="sendDraftButton" onclick="sendDraft()" disabled>Send Draft</button> <!-- Added ID and disabled by default -->
    <div id="status"></div>
  </div>

  <script>
    // ✅ Google Client ID for OAuth and Sign-In Button
    const CLIENT_ID = "617445897711-7lo4sd93bbfv8e2n0segh63uuv9h4pvl.apps.googleusercontent.com";
    let gmailAccessToken = null;
    let selectedDraftForSendingId = null;
    let selectedDraftForSendingSubject = null;
    let tokenClient;

    // Initialize Google Identity Services for the Sign-In button
    window.onload = () => {
      google.accounts.id.initialize({
        client_id: CLIENT_ID,
        ux_mode: "popup", // Ensures sign-in happens in a popup
        callback: handleCredentialResponse // Firebase sign-in after Google button auth
      });

      google.accounts.id.renderButton(
        document.getElementById("gSignInDiv"), // Corrected ID
        { theme: "outline", size: "large" }
      );

      // Initialize the Google OAuth 2.0 token client for Gmail API access
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: 'https://www.googleapis.com/auth/gmail.modify', // Sufficient for reading drafts and sending
        callback: (tokenResponse) => {
          if (tokenResponse && tokenResponse.access_token) {
            gmailAccessToken = tokenResponse.access_token;
            // You could enable UI elements that require the token here
            document.getElementById("status").textContent = "✅ Gmail permissions granted. Ready.";
            // document.getElementById("sendDraftButton").disabled = false; // Will be enabled once a draft is selected
            populateDraftList();
            console.log("Gmail API Access Token obtained.");
          } else {
            console.error("Failed to obtain Gmail API access token:", tokenResponse);
            document.getElementById("status").textContent = "❌ Failed to get Gmail permissions. Please refresh and try signing in again.";
            document.getElementById("sendDraftButton").disabled = true;
          }
        },
        error_callback: (error) => { // Added error_callback for more detailed diagnostics
          console.error("Token client error_callback:", error);
          document.getElementById("status").textContent = `❌ Gmail Permission Error: ${error.type || 'Unknown error'}. Check console.`;
          document.getElementById("sendDraftButton").disabled = true;
        },
      });
    };

    function handleCredentialResponse(response) {
      const credential = firebase.auth.GoogleAuthProvider.credential(response.credential);
      auth.signInWithCredential(credential).then(() => {
        document.getElementById("gSignInDiv").style.display = "none";
        document.getElementById("app").style.display = "block";
        // After Firebase sign-in, request Gmail API access token
        document.getElementById("status").textContent = "Requesting Gmail permissions...";
        document.getElementById("sendDraftButton").disabled = true;
        if (tokenClient) {
          tokenClient.requestAccessToken({ prompt: '' }); // prompt: '' tries to get token without new consent if already granted
        }
      }).catch(error => {
        console.error("Firebase sign-in error:", error);
        document.getElementById("status").textContent = "❌ Firebase sign-in failed.";
        document.getElementById("sendDraftButton").disabled = true;
      });
    }

    async function populateDraftList() {
      const statusDiv = document.getElementById("status");
      const draftContainer = document.getElementById("draftListContainer");
      const draftPreview = document.getElementById("draftPreviewArea");
      draftContainer.innerHTML = '<p>-- Loading drafts --</p>';
      document.getElementById("sendDraftButton").disabled = true;
      draftPreview.innerHTML = '<p>-- Click a draft above to see its content --</p>';
      selectedDraftForSendingId = null; // Reset selection

      if (!gmailAccessToken) {
        statusDiv.textContent = "❌ Gmail access token not available to fetch drafts.";
        return;
      }

      statusDiv.textContent = "Fetching drafts...";
      // Use fields parameter to get id, internalDate for sorting, and headers for subject
      // Note: payload.headers will return ALL headers. We'll filter for Subject client-side.
      const listUrl = `https://gmail.googleapis.com/gmail/v1/users/me/drafts?fields=nextPageToken,resultSizeEstimate,drafts(id,message(internalDate,payload/headers))`;
      const headers = { Authorization: `Bearer ${gmailAccessToken}` };

      try {
        const res = await fetch(listUrl, { headers });
        const data = await res.json();

        if (!res.ok || data.error) {
          console.error("Error listing drafts:", data.error || res.statusText);
          statusDiv.textContent = `❌ Error listing drafts: ${data.error?.message || res.statusText}`;
          draftContainer.innerHTML = '<p>-- Error loading drafts --</p>';
          return;
        }

        draftContainer.innerHTML = ''; // Clear loading message
        let draftsToSort = data.drafts || [];

        if (draftsToSort.length > 0) {
          // Sort drafts by internalDate, newest first
          draftsToSort.sort((a, b) => {
            const dateA = parseInt(a.message?.internalDate || "0", 10);
            const dateB = parseInt(b.message?.internalDate || "0", 10);
            return dateB - dateA; // Descending order
          });

          console.log(`Found ${data.drafts.length} drafts. Inspecting the first few:`);
          data.drafts.forEach((draftStub, index) => {
            if (index < 3) { // Log details for the first 3 drafts
              console.log(`Inspecting draftStub ID: ${draftStub.id}`);
              console.log('  draftStub.message:', JSON.stringify(draftStub.message, null, 2));
              if (draftStub.message && draftStub.message.payload) {
                console.log('  draftStub.message.payload.headers:', JSON.stringify(draftStub.message.payload.headers, null, 2));
              }
            }

            const headersArray = draftStub.message?.payload?.headers;
            // Case-insensitive search for Subject header from the fetched headers
            const subjectHeader = headersArray?.find(h => h.name && h.name.toLowerCase() === "subject");
            let subject = (subjectHeader && typeof subjectHeader.value === 'string') ? subjectHeader.value.trim() : null;
            
            const draftElement = document.createElement('div');
            draftElement.classList.add('draft-item');
            draftElement.textContent = subject ? subject : `(No Subject) - ID: ${draftStub.id}`;
            draftElement.dataset.draftId = draftStub.id;
            draftElement.dataset.draftSubject = subject ? subject : "(No Subject)"; // Store for later use

            draftElement.addEventListener('click', () => handleDraftSingleClick(draftStub.id, draftElement));
            draftElement.addEventListener('dblclick', () => handleDraftDoubleClick(draftStub.id, subject, draftElement));
            
            draftContainer.appendChild(draftElement);
          });
          statusDiv.textContent = "✅ Drafts loaded. Single-click to preview, Double-click to select for sending.";
        } else {
          draftContainer.innerHTML = '<p>-- No drafts found --</p>';
          statusDiv.textContent = "ℹ️ No drafts found in your Gmail.";
        }
      } catch (error) {
        console.error("Exception fetching drafts:", error);
        statusDiv.textContent = "❌ Exception occurred while fetching drafts.";
        draftContainer.innerHTML = '<p>-- Error loading drafts --</p>';
      }
    }

    async function handleDraftSingleClick(draftId, clickedElement) {
      const draftPreview = document.getElementById("draftPreviewArea");
      const statusDiv = document.getElementById("status");
      draftPreview.innerHTML = '<h4>Loading Preview...</h4><p>Fetching full draft content...</p>';

      // Visually indicate which item is being previewed
      document.querySelectorAll('.draft-item.previewing').forEach(el => el.classList.remove('previewing'));
      if (clickedElement) clickedElement.classList.add('previewing');

      if (!gmailAccessToken) {
        draftPreview.innerHTML = '<p>Error: Gmail access token not available.</p>';
        return;
      }

      const getDraftUrl = `https://gmail.googleapis.com/gmail/v1/users/me/drafts/${draftId}?format=full`;
      const headers = { Authorization: `Bearer ${gmailAccessToken}` };

      try {
        const res = await fetch(getDraftUrl, { headers });
        const draftData = await res.json();

        if (!res.ok || draftData.error) {
          console.error("Error fetching full draft:", draftData.error || res.statusText);
          draftPreview.innerHTML = `<p>Error fetching draft preview: ${draftData.error?.message || res.statusText}</p>`;
          return;
        }

        const subjectHeader = draftData.message?.payload?.headers?.find(h => h.name === "Subject");
        const subject = (subjectHeader && typeof subjectHeader.value === 'string') ? subjectHeader.value.trim() : "(No Subject)";
        
        const bodyContent = decodeEmailBody(draftData.message?.payload);

        draftPreview.innerHTML = `<h4>Subject: ${subject}</h4><hr><p>${bodyContent.replace(/\n/g, '<br>')}</p>`; // Basic display, consider sanitizing HTML if displaying HTML content directly
        statusDiv.textContent = `Previewing: ${subject}`;

      } catch (error) {
        console.error("Exception fetching full draft:", error);
        draftPreview.innerHTML = `<p>Exception fetching draft preview: ${error.message}</p>`;
      }
    }

    function handleDraftDoubleClick(draftId, draftSubject, clickedElement) {
      selectedDraftForSendingId = draftId;
      selectedDraftForSendingSubject = draftSubject;

      // Update visual selection
      document.querySelectorAll('.draft-item.selected-for-sending').forEach(el => el.classList.remove('selected-for-sending'));
      if (clickedElement) clickedElement.classList.add('selected-for-sending');

      document.getElementById("sendDraftButton").disabled = false;
      document.getElementById("status").textContent = `Selected for sending: "${draftSubject}"`;
      console.log(`Draft selected for sending: ID=${draftId}, Subject=${draftSubject}`);
    }

    function decodeEmailBody(payload) {
      if (!payload) return "(No body content)";

      let bodyData = "";
      let mimeType = payload.mimeType;

      if (payload.parts) {
        // Prefer text/plain, then text/html
        let plainPart = payload.parts.find(part => part.mimeType === 'text/plain');
        let htmlPart = payload.parts.find(part => part.mimeType === 'text/html');

        if (plainPart && plainPart.body && plainPart.body.data) {
          bodyData = plainPart.body.data;
          mimeType = 'text/plain';
        } else if (htmlPart && htmlPart.body && htmlPart.body.data) {
          bodyData = htmlPart.body.data;
          mimeType = 'text/html';
          // For HTML, you might want to display it as HTML or strip tags for plain text preview
          // For simplicity here, we'll treat it like text. For actual HTML rendering, use an iframe or sanitize.
        }
      } else if (payload.body && payload.body.data) {
        bodyData = payload.body.data;
      }

      if (bodyData) {
        try {
          // Decode base64url
          const decoded = atob(bodyData.replace(/-/g, '+').replace(/_/g, '/'));
          // If it was HTML and you want to show plain text, you'd strip HTML tags here.
          // For now, just returning the decoded string.
          return decoded;
        } catch (e) {
          console.error("Error decoding body data:", e);
          return "(Error decoding body)";
        }
      }
      return "(No readable body content found)";
    }

    // 📤 Send Email From Draft
    async function sendDraft() {
      const matchedDraftId = selectedDraftForSendingId;
      const subjectForLogging = selectedDraftForSendingSubject || "(No Subject Selected)";
      const to = document.getElementById("recipient").value.trim();
      const statusDiv = document.getElementById("status"); // Renamed for clarity

      if (!matchedDraftId) {
        return statusDiv.textContent = "⚠️ Please double-click a draft from the list to select it for sending.";
      }
      if (!gmailAccessToken) {
        return statusDiv.textContent = "❌ Gmail permissions not granted or token expired. Please re-login or refresh the page.";
      }
      if (!to) {
        return statusDiv.textContent = "Please enter the recipient email!";
      }
      document.getElementById("sendDraftButton").disabled = true;

      statusDiv.textContent = "Searching for draft…";

      const headers = { Authorization: `Bearer ${gmailAccessToken}` };
      // The draft search loop is no longer needed as we have the ID.

      statusDiv.textContent = "Found draft, fetching details…";

      // ✅ Step 2: Get the full draft details (including raw content) for the matched draft
      const getDraftUrl = `https://gmail.googleapis.com/gmail/v1/users/me/drafts/${matchedDraftId}`;
      const draftRes = await fetch(getDraftUrl, { headers });
      const draftMeta = await draftRes.json();

      if (!draftRes.ok || draftMeta.error) {
        console.error("Error fetching draft details:", draftMeta.error || draftRes.statusText);
        return statusDiv.textContent = `❌ Error fetching draft: ${draftMeta.error?.message || draftRes.statusText}`;
      }
      if (!draftMeta.message || !draftMeta.message.raw) {
        console.error("Error: draftMeta.message.raw is missing. Full draftMeta.message:", JSON.stringify(draftMeta.message, null, 2));
        return statusDiv.textContent = "❌ Draft content (raw) not found.";
      }

      // ✅ Step 3: Modify recipient in the raw message
      const raw = atob(draftMeta.message.raw.replace(/-/g, '+').replace(/_/g, '/'));
      const modified = raw.replace(/To: .*?\r\n/, `To: ${to}\r\n`);
      const newRaw = btoa(modified).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');

      statusDiv.textContent = "Sending email…";
      // ✅ Step 4: Send the modified message
      const sendRes = await fetch("https://gmail.googleapis.com/gmail/v1/users/me/messages/send", {
        method: "POST",
        headers: {
          Authorization: `Bearer ${gmailAccessToken}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ raw: newRaw })
      });

      if (sendRes.ok) {
        logSend(subjectForLogging, to);
        selectedDraftForSendingId = null;
        selectedDraftForSendingSubject = null;
        // Visually clear selection from the list
        const selectedItems = document.querySelectorAll('.draft-item.selected-for-sending');
        selectedItems.forEach(el => el.classList.remove('selected-for-sending'));
        // Optionally clear the recipient field
        document.getElementById("recipient").value = "";
        // Update status to reflect completion and next possible action
        statusDiv.textContent = "✅ Email sent! Double-click a draft to send another.";
        // The button remains disabled, which is correct as no draft is selected now.
      } else {
        document.getElementById("sendDraftButton").disabled = false;
        const sendError = await sendRes.json().catch(() => ({ message: "Unknown send error" }));
        console.error("Failed to send email:", sendError);
        statusDiv.textContent = `❌ Failed to send: ${sendError.error?.message || sendRes.statusText}`;
      }
    }

    // 🧾 Log sent data to Firestore
    function logSend(subject, to) {
      const user = auth.currentUser;
      if (!user) return;
      db.collection("users").doc(user.uid).collection("sentLogs").add({
        subject,
        recipient: to,
        sentAt: new Date().toISOString()
      });
    }
  </script>
</body>
</html>
